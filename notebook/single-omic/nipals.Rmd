---
title: "Single Omics NIPALS"
author: "Al J Abadi"
params:
  on_hpc: !r Sys.info()['user'] != 'alabadi'
  on_mac: !r Sys.info()['user'] == 'alabadi'
  nipals_ncomp: 2
  # grad_cols: !r c(low = "darkblue", high = "orange")
  subset: !r c(50, 100)
  rerun: false
  saveRDS: false
  repeat_runs: 1
  props_NA: !r c(0.1, 0.25, 0.4)
output:
  html_document:
    toc: true
---

```{r}
dput(params)
```

```{r, warning=FALSE, message=FALSE}
library(nipals)
library(mixOmics)
library(reticulate)
library(umap)
library(here)
library(ggplot2)
library(microbenchmark)
library(parallel)
library(SingleCellExperiment)
library(MultiAssayExperiment)

invisible(sapply(list.files(here('src', 'utils'), pattern = "*.R", full.names = TRUE), source))
```

# Data

```{r load-data}
# load(url("https://github.com/LuyiTian/sc_mixology/blob/master/data/sincell_with_class.RData?raw=true"))
# saveRDS(sce_sc_10x_qc, file = here("output", "cellbench-10x.rds"))
suppressMessages({
  ## CellBench
  cellbench_10x <- readRDS(here("output", "cellbench-10x.rds"))
  cellbench_10x_logcounts <- logcounts(cellbench_10x) %>% t()
  
  ## scNMTseq - rna
  sce <- readRDS(here("output", "sce-matching-1pct-cells-expressing.rds"))
  mae <- readRDS(here("output", "scnmtseq_gastrulation_mae_826-cells_orderedFeatures.rds"))
})

```

```{r}
source(here("src", "nipals-utils.R"))
```

# RNA Data (no weights)

## Without Gram-Schmidt

```{r}
bm_datasets_res <- list()
```

```{r rna-benchmark-load, eval=!params$rerun}
bm_datasets_res <- readRDS(here("output", "nipals-benchmark-results_all-datasets_no-gramschmidt.rds"))
```

### CellBench 10X

```{r}
data_name <- "cellbench_10x"
```

```{r cellbench-run, eval=params$rerun}
dataset <- cellbench_10x_logcounts
pheno = cellbench_10x$cell_line

props_NA <- params$props_NA
repeat_runs <- params$repeat_runs
subset <- params$subset

bm_datasets_res[[data_name]] <- benchmark_nipals(dataset = dataset, props = props_NA, pheno = pheno, subset = subset, top_n = FALSE)
```

```{r}
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 1)
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 2)
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 3)
```

### nutrimouse

Does not contain dominant axes of variation

```{r}
data_name <- "nutrimouse"
```


```{r nutrimouse-run, eval=params$rerun}
data("nutrimouse")

dataset <- nutrimouse$gene
pheno = nutrimouse$diet

props_NA <- params$props_NA
repeat_runs <- params$repeat_runs
subset <- params$subset

bm_datasets_res[[data_name]] <- benchmark_nipals(dataset = dataset, props = props_NA, pheno = pheno, subset = subset, top_n = FALSE)
```

```{r}
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 1)
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 2)
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 3)
```

### breast.tumors

Does not contain dominant axes of variation

```{r}
data_name <- "breast.tumors"
```

```{r breast-run, eval=params$rerun}
data("breast.tumors")

dataset <- breast.tumors$gene.exp
pheno = breast.tumors$sample$treatment

props_NA <- params$props_NA
repeat_runs <- params$repeat_runs
subset <- params$subset

bm_datasets_res[[data_name]] <- benchmark_nipals(dataset = dataset, props = props_NA, pheno = pheno, subset = subset, top_n = FALSE)
```

```{r}
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 1)
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 2)
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 3)
```

### scNMTseq

```{r}
data_name <- "scnmtseq"
```

```{r scnmtseq-run, eval=params$rerun}
sce <- sce[,sce$lineage %in% c("Mesoderm", "Endoderm", "Ectoderm")]
sce <- sce[order(rowVars(logcounts(sce)), decreasing = TRUE),]
scnmtseq <- logcounts(sce) %>% t()

dataset <- scnmtseq
pheno = sce$lineage

props_NA <- params$props_NA
repeat_runs <- params$repeat_runs
subset <- params$subset

bm_datasets_res[[data_name]] <- benchmark_nipals(dataset = dataset, props = props_NA, pheno = pheno, subset = subset, top_n = FALSE)
```

```{r}
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 1)
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 2)
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 3)
```

```{r saveruns1, eval=params$rerun&params$saveRDS}
saveRDS(bm_datasets_res, file = here("output", "nipals-benchmark-results_all-datasets_no-gramschmidt.rds"))
```

```{r}
bm_datasets_res <- readRDS(here("output", "nipals-benchmark-results_all-datasets_no-gramschmidt.rds"))
```


### Runtimes

```{r}
df <- get_all_runtimes(propNA_vec = names(bm_datasets_res[[1]])[1:3], bm_res = bm_datasets_res)
ggplot_all_runtimes(df, x = "Dataset", y = "Mean Runtime (sec)", title = "NIPALS")
```

# Epigenome Data

## runtime with limited number of features

```{r}

```

```{r}
epi_data <- names(mae)[c(2:5)] %>% .[!grepl(pattern = "^wt*", .)]
```

```{r epi-data, eval=params$rerun}
epi_data <- names(mae)[c(2:5)] %>% .[!grepl(pattern = "^wt*", .)]
for (data_name in epi_data) {
  dataset <- assay(mae, data_name) %>% t()
  weights <- assay(mae, paste0("wt_",data_name)) %>% t()
  pheno = mae$day
  
  props_NA <- c(0)
  repeat_runs <- 1
  subset <- c(0, 300)
  ncomp = params$nipals_ncomp
  
  bm_datasets_res[[data_name]] <- benchmark_nipals(dataset = dataset, weights = weights, props = props_NA, pheno = pheno, subset = subset, ncomp = ncomp, microbench = TRUE)
  saveRDS(bm_datasets_res[[data_name]], file = here("output", "tmp", sprintf("nipals-benchamrk-%s.rds", data_name)))
}
```

```{r saveruns2, eval=params$rerun&params$saveRDS}
saveRDS(bm_datasets_res[epi_data], file = here("output", "nipals-benchmark-results_epi-data-subset-microbenchmarked.rds"))
```

```{r epi-data-benchmark-load, eval=!params$rerun}
epi_data_res <- readRDS(here("output", "nipals-benchmark-results_epi-data-subset-microbenchmarked.rds"))
epi_data <- names(epi_data_res)
bm_datasets_res[epi_data] <- epi_data_res
rm(epi_data_res)
```

```{r}
df <- get_all_runtimes(propNA_vec = names(bm_datasets_res[epi_data][[1]])[1], bm_res = bm_datasets_res[epi_data])
ggplot_all_runtimes(df, x = "Dataset", y = "Mean Runtime (sec)", title = "NIPALS")
```

```{r}
all_epi_plots <- lapply(named_list(epi_data), function(data_name) {
  show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 1, empca = TRUE, subtitle = data_name)
})
all_epi_plots
```


