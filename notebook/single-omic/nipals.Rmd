---
title: "Single Omics"
author: "Al J Abadi"
params:
  on_hpc: !r Sys.info()['user'] != 'alabadi'
  on_mac: !r Sys.info()['user'] == 'alabadi'
  nipals_ncomp: 20
  grad_cols: !r c(low = "darkblue", high = "orange")
  rerun: false
output:
  html_document:
    toc: true
---

```{r, warning=FALSE, message=FALSE}
library(nipals)
library(mixOmics)
library(reticulate)
library(umap)
library(here)
library(ggplot2)
library(microbenchmark)
library(parallel)
library(SingleCellExperiment)
library(MultiAssayExperiment)

sapply(list.files(here('src', 'utils'), pattern = "*.R", full.names = TRUE), source)
```

# Data

```{r load-data, eval=params$rerun}
# load(url("https://github.com/LuyiTian/sc_mixology/blob/master/data/sincell_with_class.RData?raw=true"))
# saveRDS(sce_sc_10x_qc, file = here("output", "cellbench-10x.rds"))
suppressMessages({
  ## CellBench
  cellbench_10x <- readRDS(here("output", "cellbench-10x.rds"))
  cellbench_10x_logcounts <- logcounts(cellbench_10x) %>% t()
  
  ## scNMTseq - rna
  sce <- readRDS(here("output", "sce-matching-1pct-cells-expressing.rds"))
  mae <- readRDS(here("output", "scnmtseq_gastrulation_mae_826-cells_orderedFeatures.rds"))
})

```

```{r}
source(here("src", "nipals-utils.R"))
```

# RNA Data (no weights)

## Without Gram-Schmidt

```{r}
bm_datasets_res <- list()
```

```{r}
# data.frame(
#   cellbench = list(dataset = cellbench_10x_logcounts, props_NA = c(0.1, 0.3, 0.5), repeat_runs = 1, subset = c(300, 600), pheno = cellbench_10x$cell_line),
#   nutrimouse = list(dataset = nutrimouse$gene, props_NA = c(0.1, 0.3, 0.5), repeat_runs = 1, subset = c(300, 600), pheno = nutrimouse$diet),
#   breast.tumors = list(dataset = breast.tumors$gene.exp, props_NA = c(0.1, 0.3, 0.5), repeat_runs = 1, subset = c(300, 600), pheno = breast.tumors$sample$treatment)
# )
```

```{r rna-benchmark-load, eval=!params$rerun}
bm_datasets_res <- readRDS(here("output", "nipals-benchmark-results_all-datasets_no-gramschmidt.rds"))
```


### CellBench 10X

```{r}
data_name <- "cellbench_10x"
```

```{r cellbench-run, eval=params$rerun}
dataset <- cellbench_10x_logcounts
props_NA <- c(0.1, 0.25, 0.4)
repeat_runs <- 1
subset <- c(300, 500)
pheno = cellbench_10x$cell_line

bm_datasets_res[[data_name]] <- benchmark_nipals(dataset = dataset, props = props_NA, pheno = pheno, subset = subset)
```

```{r}
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 1)
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 2)
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 3)
```

### nutrimouse

Does not contain dominant axes of variation

```{r}
data_name <- "nutrimouse"
```


```{r nutrimouse-run, eval=params$rerun}
data("nutrimouse")
dataset <- nutrimouse$gene
props_NA <- c(0.1, 0.25, 0.4)
repeat_runs <- 6
pheno = nutrimouse$diet

bm_datasets_res[[data_name]] <- benchmark_nipals(dataset = dataset, props = props_NA, pheno = pheno, subset = subset)
```

```{r}
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 1)
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 2)
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 3)
```

### breast.tumors

Does not contain dominant axes of variation

```{r}
data_name <- "breast.tumors"
```

```{r breast-run, eval=params$rerun}
data("breast.tumors")
dataset <- breast.tumors$gene.exp
props_NA <- c(0.1, 0.25, 0.4)
repeat_runs <- 1
subset <- c(300, 500)
pheno = breast.tumors$sample$treatment
bm_datasets_res[[data_name]] <- benchmark_nipals(dataset = dataset, props = props_NA, pheno = pheno, subset = subset)
```

```{r}
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 1)
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 2)
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 3)
```

### scNMTseq

```{r}
data_name <- "scnmtseq"
```

```{r scnmtseq-run, eval=params$rerun}
sce <- sce[,sce$lineage %in% c("Mesoderm", "Endoderm", "Ectoderm")]
sce <- sce[order(rowVars(logcounts(sce)), decreasing = TRUE),]
scnmtseq <- logcounts(sce) %>% t() %>% .[,1:2000]
dataset <- scnmtseq
props_NA <- c(0.1, 0.25, 0.4)
repeat_runs <- 1
subset <- c(300, 500)
pheno = sce$lineage

bm_datasets_res[[data_name]] <- benchmark_nipals(dataset = dataset, props = props_NA, pheno = pheno, subset = subset)
```

```{r}
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 1)
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 2)
show_benchmark_res(bm_res = bm_datasets_res[[data_name]], which = 3)
```

```{r saveruns, eval=params$rerun}
saveRDS(bm_datasets_res, file = here("output", "nipals-benchmark-results_all-datasets_no-gramschmidt.rds"))
```

```{r}
get_datasets_runtimes <- function(propNA, bm_res) {
  theList <- lapply(bm_res, function(x){
    summary(x[[propNA]][["microbenchmark"]])[,c("expr","mean")]
  })
  rbindListWithNames(theList)
}

get_all_runtimes <- function(propNA_vec, bm_res) {
  theList <- lapply(named_list(propNA_vec), function(x) {
    get_datasets_runtimes(x, bm_res = bm_res)
  })
  rbindListWithNames(theList, new_col = "prop_NA")
}

```

```{r}
ggplot_all_runtimes <- function(df, ...) {
  ggplot(df, aes(x = factor(dataset), y = mean))  +  geom_point(aes(col = expr, shape = prop_NA), size=3)  +  theme_bw()  + 
    guides(col = guide_legend(title = "function"), shape = guide_legend(title = "NA proportion"))  + 
    labs(...)
}
```

### Runtimes

```{r}
df <- get_all_runtimes(propNA_vec = names(bm_datasets_res[[1]])[1:2], bm_res = bm_datasets_res)
ggplot_all_runtimes(df, x = "Dataset", y = "Mean Runtime (sec)", title = "NIPALS")
```




