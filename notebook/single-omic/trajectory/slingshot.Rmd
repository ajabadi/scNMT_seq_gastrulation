---
title: "block.splsda excluidng rna using annot as Y"
author: "Al J Abadi"
params:
  on_hpc: !r Sys.info()['user'] != 'alabadi'
  on_mac: !r Sys.info()['user'] == 'alabadi'
  rerun: false
output:
  html_document:
    toc: true
---

```{r, echo=FALSE}
knitr::opts_chunk$set(eval = TRUE, cache = !FALSE, warning = FALSE, out.width = "100%")
```

# TO DO

* Use semi-supervised slingshot and look at prediction accuracy, or use one 'Omic as train and one as test.
* Use stage_lineage as cluster label and see if slingshot accurately captures the lineages 
* How were the clusters/annotations done?

# Description

* lineage reconstruction and pseudotime inference.
* The goal of slingshot is to use clusters of cells to uncover global structure and convert this structure into smooth lineages represented by one-dimensional variables, called “pseudotime.”
* We provide tools for learning cluster relationships in an unsupervised or semi-supervised manner and constructing smooth curves representing each lineage
* The clusters identified in this step will be used to determine the global structure of the underlying lineages

# I/O to Slinsghot

The minimal input to slingshot is a matrix representing the cells in a reduced-dimensional space and a vector of cluster labels. With these two inputs, we then:

- Identify the global lineage structure by constructing an minimum spanning tree (MST) on the clusters, with the getLineages function.
- Construct smooth lineages and infer pseudotime variables by fitting simultaneous principal curves with the getCurves function.
- Assess the output of each step with built-in visualization tools.

Two-step Process:

* identifying the global lineage structure with a cluster-based minimum spanning tree (MST)
* fitting simultaneous principal curves to describe each lineage.

```{r}
# BiocManager::install('slingshot')
library(slingshot)
```


```{r, warning=FALSE, message=FALSE}
library(MultiAssayExperiment)
library(here)
library(uwot)
```


```{r}
source(here("src/source-utils.R"))
```

## Data

```{r}
gastru.mae <- readRDS(here('output/scnmtseq_gastrulation_mae_826-cells_orderedFeatures.rds'))  # MAE experiment
# gastru.mae <- gastru.mae[,!is.na(gastru.mae$lineage10x_2) & gastru.mae$lineage10x_2 %in% c("Epiblast", "Mesoderm", "Endoderm", "Ectoderm"),]
gastru.mae <- gastru.mae[,!is.na(gastru.mae$lineage10x_2) & ! (gastru.mae$lineage10x_2 %in% c("ExE_ectoderm")),]
```


check column names are consistent:

```{r}
all_identical(colnames(gastru.mae))
```

```{r}
coldata <- data.frame(colData(gastru.mae))
```

## RNA

```{r}
rna <- assay(gastru.mae, 'rna')
```


## UMAP


```{r}
ncomp <- 10
filename <- sprintf('umap-result-ncomp-%s.rds', ncomp)
```

```{r, eval=FALSE}
set.seed(42)
umap_rna_unsup <- umap::umap(t(rna), method = 'umap-learn', n_components = ncomp, metric = 'euclidean', knn_repeats = 3, min_dist = 0.7)
```

```{r, eval=FALSE}
saveRDS(umap_rna_unsup, file = filename)
```

```{r}
umap_rna_unsup <- readRDS(filename)
```



```{r}
## supervised learning
# umap_rna_sup <- uwot::umap(t(rna), n_neighbors = 15, n_components = 2, metric = 'euclidean', scale = 'none', min_dist = 1e-5, y = coldata$lineage10x_2)
## unsupervised learning
# umap_rna_unsup <- uwot::umap(t(rna), n_neighbors = 15, n_components = 4, metric = 'euclidean', scale = 'none', min_dist = 1e-5)

```

### Plot UMAP

```{r}
gg_sidebyside <- function(p1, p2) {
  library(egg)
  egg::ggarrange(plots = list(p1, ggplot() + theme_void(), p2), nrow = 1, widths = c(5,1,5))
}

gg_sidebyside_dims <- function(arr, dims) {
  g1 <- ggplot_redDim(arr, col = coldata$stage, dims = dims, grad_cols = c('#37a6f0', '#121296'))
  g2 <- ggplot_redDim(arr, col = coldata$lineage10x_2, dims = dims, grad_cols = NULL, col.legend = 'Lineage')
  gg_sidebyside(g1, g2)
}
```

```{r}
p12 <- gg_sidebyside_dims(arr =  umap_rna_unsup$layout, dims = c(1,2))
p34 <- gg_sidebyside_dims(arr =  umap_rna_unsup$layout, dims = c(3,4))
```
```{r}
ggsave(filename = 'umap12-rna.pdf', plot = p12, width = 12, height = 5)
ggsave(filename = 'umap34-rna.pdf', plot = p34, width = 12, height = 5)
```

### Plot a gene's mean expression

```{r}
gene_i <- rownames(rna)[1]
ggplot_redDim_expression(arr = umap_rna_unsup$layout, col = rna[2,], dims = c(3,4))
```


## Promoter Accessibility

```{r}
acc_promoter <- assay(gastru.mae, 'acc_promoter')
```

```{r}
acc_promoter <- t(impute_by_means(t(acc_promoter)))
```


## UMAP


```{r}
ncomp <- 10
filename <- sprintf('umap-result-ncomp-%s.rds', ncomp)
```

```{r, eval=FALSE}
set.seed(42)
umap_acc_promoter_unsup <- umap::umap(t(acc_promoter), method = 'umap-learn', n_components = ncomp, metric = 'euclidean', knn_repeats = 3, min_dist = 0.7)
```

```{r, eval=FALSE}
saveRDS(umap_acc_promoter_unsup, file = filename)
```

```{r}
umap_acc_promoter_unsup <- readRDS(filename)
```



```{r}
## supervised learning
# umap_rna_sup <- uwot::umap(t(rna), n_neighbors = 15, n_components = 2, metric = 'euclidean', scale = 'none', min_dist = 1e-5, y = coldata$lineage10x_2)
## unsupervised learning
# umap_rna_unsup <- uwot::umap(t(rna), n_neighbors = 15, n_components = 4, metric = 'euclidean', scale = 'none', min_dist = 1e-5)

```

### Plot UMAP

```{r}
gg_sidebyside <- function(p1, p2) {
  library(egg)
  egg::ggarrange(plots = list(p1, ggplot() + theme_void(), p2), nrow = 1, widths = c(5,1,5))
}

gg_sidebyside_dims <- function(arr, dims) {
  g1 <- ggplot_redDim(arr, col = coldata$stage, dims = dims, grad_cols = c('#37a6f0', '#121296'))
  g2 <- ggplot_redDim(arr, col = coldata$lineage10x_2, dims = dims, grad_cols = NULL, col.legend = 'Lineage')
  gg_sidebyside(g1, g2)
}
```

```{r}
p12 <- gg_sidebyside_dims(arr =  umap_acc_promoter_unsup$layout, dims = c(1,2))
p34 <- gg_sidebyside_dims(arr =  umap_acc_promoter_unsup$layout, dims = c(3,4))
```
```{r}
ggsave(filename = 'umap12-acc_promoter.pdf', plot = p12, width = 12, height = 5)
ggsave(filename = 'umap34-acc_promoter.pdf', plot = p34, width = 12, height = 5)
```

## Promoter Methylation

```{r}
met_promoter <- assay(gastru.mae, 'met_promoter')
```

```{r}
met_promoter <- t(impute_by_means(t(met_promoter)))
```


## UMAP


```{r}
ncomp <- 10
filename <- sprintf('umap-result-ncomp-%s.rds', ncomp)
```

```{r, eval=FALSE}
set.seed(42)
umap_met_promoter_unsup <- umap::umap(t(met_promoter), method = 'umap-learn', n_components = ncomp, metric = 'euclidean', knn_repeats = 3, min_dist = 0.7)
```

```{r, eval=FALSE}
saveRDS(umap_met_promoter_unsup, file = filename)
```

```{r}
umap_met_promoter_unsup <- readRDS(filename)
```



```{r}
## supervised learning
# umap_rna_sup <- uwot::umap(t(rna), n_neighbors = 15, n_components = 2, metric = 'euclidean', scale = 'none', min_dist = 1e-5, y = coldata$lineage10x_2)
## unsupervised learning
# umap_rna_unsup <- uwot::umap(t(rna), n_neighbors = 15, n_components = 4, metric = 'euclidean', scale = 'none', min_dist = 1e-5)

```

### Plot UMAP

```{r}
gg_sidebyside <- function(p1, p2) {
  library(egg)
  egg::ggarrange(plots = list(p1, ggplot() + theme_void(), p2), nrow = 1, widths = c(5,1,5))
}

gg_sidebyside_dims <- function(arr, dims) {
  g1 <- ggplot_redDim(arr, col = coldata$stage, dims = dims, grad_cols = c('#37a6f0', '#121296'))
  g2 <- ggplot_redDim(arr, col = coldata$lineage10x_2, dims = dims, grad_cols = NULL, col.legend = 'Lineage')
  gg_sidebyside(g1, g2)
}
```

```{r}
p12 <- gg_sidebyside_dims(arr =  umap_met_promoter_unsup$layout, dims = c(1,2))
p34 <- gg_sidebyside_dims(arr =  umap_met_promoter_unsup$layout, dims = c(3,4))
```
```{r}
ggsave(filename = 'umap12-met_promoter.pdf', plot = p12, width = 12, height = 5)
ggsave(filename = 'umap34-met_promoter.pdf', plot = p34, width = 12, height = 5)
```


## Slingshot

```{r}
library(SingleCellExperiment)
sce_rna <- SingleCellExperiment(assays = list(logcouns = rna), reducedDims = SimpleList(UMAP = umap_rna_unsup$layout[,1:5], PCA = pca_rna$variates$X ))
colData(sce_rna) <- DataFrame(coldata)
```


```{r}
ss <- slingshot(data = sce_rna, clusterLabels = 'stage_lineage', reducedDim = 'UMAP')
```

```{r}
summary(ss$slingPseudotime_1)
```
```{r}
colors <- colorRampPalette(brewer.pal(11,'Spectral')[-6])(100)
pseudotime_col <- colors[cut(ss$slingPseudotime_1, breaks=100)]

ggplot_redDim(arr, col = coldata$stage, shape = coldata$lineage10x_2, dims = c(3,4))
ggplot_redDim(arr, col = pseudotime_col, shape = coldata$lineage10x_2, dims = c(1,2))

plot(reducedDims(ss)$PCA, col = plotcol, pch=16, asp = 1)
```

```{r}
library(RColorBrewer)
psdtime <- cut(ss$slingPseudotime_4, breaks=10)
# psdtime <- levels(addNA(psdtime))
colors <- colorRampPalette(brewer.pal(11,'Spectral')[-6])(100)
plotcol <- colors[psdtime]

plot(reducedDims(ss)$UMAP[,3:4], col = plotcol, pch=16, asp = 1)
lines(foo@curves$curve1$s[,3:4], lwd=2, col='black')
```

