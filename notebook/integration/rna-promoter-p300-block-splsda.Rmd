---
title: "block.spls using rna, promoter, and p300 enhancer sites"
author: "Al J Abadi"
params:
  on_hpc: !r Sys.info()['user'] != 'alabadi'
  on_mac: !r Sys.info()['user'] == 'alabadi'
  rerun: false
output:
  html_document:
    toc: true
---

```{r, warning=FALSE, message=FALSE}
library(MultiAssayExperiment)
library(mixOmics)
library(here)
```


```{r, echo=FALSE}
knitr::opts_chunk$set(eval = TRUE, cache = !FALSE, warning = FALSE, out.width = "100%")
```


```{r}
source(here("src/source-utils.R"))
```

## Data

```{r}
gastru.mae <- readRDS(here('output/scnmtseq_gastrulation_mae_826-cells_orderedFeatures.rds'))  # MAE experiment
gastru.mae <- gastru.mae[,!is.na(gastru.mae$lineage10x_2),]
```


check column names are consistent:

```{r}
all_identical(colnames(gastru.mae))
```

## designate assays

```{r}
study_assays <- c("rna", "met_promoter", "acc_p300", "met_genebody", "acc_DHS")
# study_assays <- c("rna", "met_genebody", "met_promoter", "met_cgi",  "acc_promoter", "acc_cgi",  "acc_p300", "acc_CTCF", "acc_DHS")
```


```{r}
study_mae <- gastru.mae[,,study_assays]
# study_mae <- study_mae[,(study_mae$day %in%  c(4.5, 7.5)) 
#                        # & (study_mae$lineage10x_2 %in% c("Epiblast", "Mesoderm", "Endoderm", "Ectoderm"))
#                       ,]
coldata <- data.frame(colData(study_mae))
# coldata$lineage10x_2[is.na(coldata$lineage10x_2)] <- "Unknown"
```

## run block.splsda

```{r}
X <- lapply(as.list(experiments(study_mae)), t)
X <- suffix_colnames(X, indices = seq_along(X)[-1])

# if (params$on_mac) {
#   X <- lapply(X,  subset_pn, p=2000)
# }
lapply(X, dim)
Y <- coldata$lineage10x_2
```


```{r, eval = params$rerun}
design <- create_design(mae = study_mae, off_diag = 0.5, rna_only = TRUE)
keepX <- create_keepX(study_mae, keepX = c(50, 50))

block.splsda.res <- block.splsda(X = X, Y = Y, ncomp = 2, keepX = keepX)
```

```{r, eval = params$rerun}
saveRDS(block.splsda.res, file = here("output/block.splsda.res.rds"))
```

```{r, eval = !params$rerun}
block.splsda.res <- readRDS(here("output/block.splsda.res.rds"))
```


```{r}
# pdf("diablo-FirstAndLastStages-AllLineages.pdf", width = 12, height = 8)
plotIndiv(block.splsda.res, pch=factor(coldata$lineage10x_2), group = study_mae$stage, legend = TRUE, comp = 1:2, blocks = seq_along(X), legend.title = "Stage", legend.title.pch = "Lineage", cex = 1, size.subtitle = 10)
# dev.off()
# plotIndiv(block.splsda.res, pch=16, group = coldata$lineage10x_2, legend = TRUE, comp = 1:2, blocks = seq_along(X), legend.title = "Lineage")
```

Methylation in promoters and accessibility in p300 enhancers seem to correlate with embryonic days:

```{r}
library(data.table)
coldata_dt <- data.table(coldata, keep.rownames = "cell", check.names = FALSE, stringsAsFactors = FALSE)
selected_features <- selectVar(block.splsda.res)[seq_along(X)]
```

### mean rate for selected features by stage

```{r}
boxplot_means <- function(omic, x_lab, y_lab, weights = "+", show_enrichment = FALSE, title = NULL ) {
  
  keep_features <- selected_features[[omic]]$name
  
  if (weights == "+") {
    keep_features <- keep_features[selected_features[[omic]]$value$value.var > 0]
  } else if (weights == "-") {
    keep_features <- keep_features[selected_features[[omic]]$value$value.var < 0]
  }
  if (length(keep_features) < 1)
    stop("No features with requested weights")
  
  dt_background <- data.table(X[[omic]], keep.rownames = "cell", check.names = FALSE, stringsAsFactors = FALSE)
  dt_background <- melt.data.table(dt_background, variable.name = "feature", value.name = "rate")
  dt_background <- data.table::merge.data.table(dt_background, coldata_dt)
  
  dt <- dt_background[feature %in% keep_features]
  
  df_background <- data.frame(dt_background[,.(mean_rate = mean(rate, na.rm=TRUE)), by = c("lineage10x_2", "feature")])
  df <- data.frame(dt[,.(mean_rate = mean(rate, na.rm=TRUE)), by = c("lineage10x_2", "feature")])
  p <- ggplot(df, aes(x = lineage10x_2, y = mean_rate))  
  p <- p + geom_boxplot(data = df_background, aes(x = lineage10x_2, y = mean_rate), fill = "grey75", alpha = 0.75, outlier.shape = NA, coef = 0)
  
  p <- p + geom_violin(aes(fill = lineage10x_2))  +  geom_boxplot(aes(fill = lineage10x_2), width = 0.1, alpha = 0.4 )  + 
    labs(x = x_lab, y = y_lab, title = title)  +  theme_bw()  + 
    geom_jitter(size = 1, col = "grey30", position = position_jitter(0.3))
  
  
  list(plot=p, df=df)
}
```

For Pathway Analysis

```{r}
library(biomaRt)
mouse = useMart("ensembl", dataset = "mmusculus_gene_ensembl")
```

```{r}
get_bm <- function(genes) {
  getBM(
  filters = "ensembl_gene_id",
  attributes = c("ensembl_gene_id", "entrezgene_id"),
  values = genes,
  mart = mouse
)
}
```
```{r}
enrich_sig_pathway <- function(block) {
c
}
```

#### rna

```{r}
boxplot_means(omic = "rna", x_lab = "Embryonic Stage", y_lab = "mean gene expression across cells", weights = "both", title = "All Features")
boxplot_means(omic = "rna", x_lab = "Embryonic Stage", y_lab = "mean gene expression across cells", weights = "+", title = "posititive weights")
```

```{r}
rna_negative <- boxplot_means(omic = "rna", x_lab = "Embryonic Stage", y_lab = "mean gene expression across cells", weights = "-", title = "negative weights")
rna_negative$plot
```


```{r}
rna_reactome <- enrich_sig_pathway(block = "rna")
summary(rna_reactome)
```

#### met_promoter

No negative weights

```{r}
met_promoter <- boxplot_means(omic = "met_promoter", x_lab = "Embryonic Stage", y_lab = "mean promoter methylation", weights = "+")
met_promoter$plot
```

```{r}
genes <- stringr::str_extract(string = selected_features$met_promoter$name, pattern = "^ENSMUSG[0-9]*")
genes_BM <- get_bm(genes = genes)
library(ReactomePA)
rna_reactome <- enrichPathway(genes_BM$entrezgene_id, organism = "mouse", readable = TRUE)
summary(rna_reactome)


library(ReactomePA)
met_promoter_reactome <- enrichPathway(genes_BM$entrezgene_id, organism = "mouse", readable = TRUE)
summary(met_promoter_reactome)
```

#### met_genebody

No negative weights

```{r}
met_genebody <- boxplot_means(omic = "met_genebody", x_lab = "Embryonic Stage", y_lab = "mean genebody methylation")
met_genebody$plot
```
```{r}
met_genebody$df
```
```{r}
genes <- stringr::str_extract(string = met_genebody$df$feature, pattern = "^ENSMUSG[0-9]*")
library(biomaRt)
mouse = useMart("ensembl", dataset = "mmusculus_gene_ensembl")
genes_BM <- getBM(
  filters = "ensembl_gene_id",
  attributes = c("ensembl_gene_id", "entrezgene_id"),
  values = genes,
  mart = mouse
)
library(ReactomePA)
genes_reactome <- enrichPathway(genes_BM$entrezgene_id, organism = "mouse", readable = TRUE)
summary(genes_reactome)
```

```{r}
barplot(genes_reacome)
emapplot(genes_reacome)
cnetplot(genes_reacome)
```


#### acc_p300

```{r}
boxplot_means(omic = "acc_p300", x_lab = "Embryonic Stage", y_lab = "mean enhancer accessibility")
```

#### acc_DHS

```{r}
boxplot_means(omic = "acc_p300", x_lab = "Embryonic Stage", y_lab = "mean gene expression across cells")
```

```{r}
# plotVar(block.spls.res, var.names = FALSE, pch = c(16:21), cutoff = 0.5, legend = TRUE)
```

```{r}
# corMat <- network(block.spls.res, save = "pdf", name.save = "block.spls.network", cutoff = 0.81)
```




```{r}
# library(knitr)
# include_graphics("block.spls.network.pdf")
```

## run block.spls

```{r, eval = params$rerun}
Y_both <- cbind(gastru.mae$day, unmap(gastru.mae$lineage10x_2)) %>% set_colnames(c("day", unique(gastru.mae$lineage10x_2))) %>% set_rownames(rownames(X[[1]]))
block.spls.res <- block.spls(X = X, Y = Y_both, ncomp = 2, keepX = keepX, scale = FALSE)
saveRDS(block.spls.res, file = here("output","block.spls.res-Y-both-stage-lineage.rds"))
```
```{r, eval = !params$rerun}
block.spls.res <- readRDS(here("output","block.spls.res-Y-both-stage-lineage.rds"))
```

```{r}
plotIndiv(block.spls.res, pch=16, group = study_mae$day, legend = TRUE, comp = 1:2, blocks = seq_along(X), legend.title = "Stage")
plotIndiv(block.spls.res, pch=16, group = study_mae$lineage10x_2, legend = TRUE, comp = 1:2, blocks = seq_along(X), legend.title = "Lineage")
```

